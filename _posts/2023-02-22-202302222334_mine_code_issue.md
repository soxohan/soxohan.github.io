---
layout: post
title: "Code-Score"
category: my_progress
changefreq : daily
priority : 1.0
comments : true
permalink : /:categories/:year/:month/:day/:title/
math_use : true
sitemap : false

---

~~마치 밀린 연구노트를 쓰는 듯한 기분. 오늘부터 일찍 자야한다는 마음으로 날짜는 두개!~~

🗓️ 2023.02.22

- score와 관련하여 항상 고민이 있었다.
  - seq_len으로 묶은 것을 모두 같은 라벨을 갖게 하는게 맞는지.
  - 아니면 원래의 test row가 각각의 라벨을 갖도록 수정을 해주어야 하는지.
  - → 전자의 방법을 기본 방법, 후자의 방법을 back 방법이라고 하고 둘을 비교해보고 싶었다.



### 해결과정

back을 구현하는 과정에서 이슈가 몇 가지 있었다. 이전에 작성한 것처럼 evaluation 속도가 너무 느려서 코드 수정이 쉽지 않았다.

그래서 살펴보았을 때 문제가 될 수 있는 부분은 .cpu().detach() 부분이었다. 너무 많은 오버헤드가 걸리는 느낌이었다.

따라서 구글링을 해보았을때, list에 cpu변환없이 그대로 집어넣고 다음과 같이 코드를 넣어주면 각 요소를 cpu변환해서 넣어준 것과 같은 효과를 나타내었다.

```python
new_tensor = torch.tensor(list_of_tensors, device='cpu').numpy()
```

이후, 속도가 매우 빨라진 것을 체감가능했다. ~~역시 이상하게 짜면 안돌아..~~

이제는 알고리즘의 문제였다. ~~이건 짜봤는데도 왜 헷갈리냐고ㅜㅜㅜ~~

약 이틀간의 계산 실수가 이루어졌고, 지금도 절반의 차이가 나긴한다.. 작성하다보면 찾을 수 있을까 하여 기록해본다.

예시는 SMD의 데이터를 이용하였다.

<img width="724" alt="image" src="https://user-images.githubusercontent.com/85778937/220660485-4bdd79c3-912b-4c09-ac4b-0bbbd66270b1.png">

개수가 에러가 있어서 다시 확인할 예정!!!

우선 이렇게 한 상태에서 데이터 성능을 확인해보면, 0.001의 성능차이를 가지고 원래(point adjust)의 과정이 항상 조금 더 높은 성능을 보인다. ~~이렇게 되면 point adjust가 overestimate한다고 한 AAAI 논문이 떠오르는군..~~

여튼 여기까지의 내용인데, 내가 중간에 실수가 있어서 함수를 잘못 나누는 바람에 함수를 좀 이상하게 만든 것 같기는 하다.

이러한 과정에서 score라는 것은 두 가지의 과정이 존재하는 것으로 보았다. 그 과정의 이름을 다음과 같은 class 이름으로 설정하였다.

- make_pred
  pred를 어떠한 기준으로 만들것이냐는 것이다. error를 주고, 어떠한 기준으로 anomaly라고 줄 것인지, 즉 anomaly 기준과 관련한 클래스이다.
- calculate_score
  앞서 말한 전자와 후자의 방법이 들어있다. f1/recall/precision을 계산하는 것에 있어서 그냥 그대로 pred를 이용할 것인지. back의 방법을 이용하여 원래 row를 시계열 순서대로 돌린 후 사용할 것인지. 

그 과정에서 trainer에 두 개의 method를 추가하였는데, 그거 사용이 좀 맘에 안들어서 좋은 방향성이 잡히면 다시 수정해서 작성할 예정이다.

---

### score와 관련하여 계획이라도 짜놔야지..

case를 4가지 설정하여 한 번 계산을 해보려했는데, 우선 이걸 계속 진행할지에 대한 의문이 들어서 (위에서 계산한게 비슷해서...ㅜㅜ)

우선 내 생각만 기록해두려 한다. 자꾸 모든 걸 잊고 있기 때문에..

정상 분포와 anomaly 분포를 정해두고 거기서 1~3%의 데이터만을 anomaly 분포에서 넣을 생각이었다. 이 떄의 분포는 4가지의 형태를 가진다.

- 앞쪽에 몰린
- 뒤쪽에 몰린
- 흩어진
- 쏠린 (앞이랑 겹치나..?)

이러한 상태에서 score 계산을 했을 때의 차이를 보여주고 싶었는데, 당연히 비슷한게 맞나 싶어서 고민이다..
